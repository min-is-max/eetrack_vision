# ë°°í¬ìš© ëŸ¬untime ì´ë¯¸ì§€: Isaac Lab 2.1.0
FROM nvcr.io/nvidia/isaac-lab:2.1.0

RUN --mount=type=cache,target=/var/cache/apt \
    apt-get update && apt-get install -y --no-install-recommends \
      git curl wget ca-certificates tini \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /opt/wld
COPY deploy/requirements.runtime.txt /opt/wld/requirements.runtime.txt

# ğŸ”‘ ë¹Œë“œ ê²©ë¦¬ OFF â†’ sdistê°€ torchë¥¼ í•„ìš”ë¡œ í•  ë•Œ í˜„ì¬ í™˜ê²½ì˜ torch ì‚¬ìš©
ENV PIP_NO_BUILD_ISOLATION=1

# 1) PyTorch/cu124 ì¡°í•© (Isaac Lab ìš”êµ¬ ë²„ì „ê³¼ ì¼ì¹˜)
#    ì°¸ê³ : ê³µì‹ ì´ì „ ë²„ì „ ë§¤íŠ¸ë¦­ìŠ¤ì— cu124 íœ  ì œê³µë¨
#    https://download.pytorch.org/whl/cu124  (torch 2.5.1 / torchvision 0.20.1)
RUN --mount=type=cache,target=/root/.cache/pip \
    /workspace/isaaclab/_isaac_sim/python.sh -m pip install --upgrade pip && \
    /workspace/isaaclab/_isaac_sim/python.sh -m pip install \
      --index-url https://download.pytorch.org/whl/cu124 \
      torch==2.5.1 torchvision==0.20.1

# 2) PyG(+í™•ì¥) â€” torch 2.5.1 + cu124ì— ë§ëŠ” íœ ì—ì„œ ì„¤ì¹˜
#    ë§í¬ ì¸ë±ìŠ¤: https://data.pyg.org/whl/ (torch-2.5.1+cu124.html ì¡´ì¬)
RUN /workspace/isaaclab/_isaac_sim/python.sh -m pip install \
      torch_geometric==2.6.1 \
      pyg_lib torch_scatter torch_sparse torch_cluster torch_spline_conv \
      -f https://data.pyg.org/whl/torch-2.5.1+cu124.html

# 3) ë‚˜ë¨¸ì§€ ì˜ì¡´ì„±
RUN /workspace/isaaclab/_isaac_sim/python.sh -m pip install --no-build-isolation -r /opt/wld/requirements.runtime.txt

# í”„ë¡œì íŠ¸ ì†ŒìŠ¤
WORKDIR /workspace
COPY . /workspace/welding_line_detection
RUN mkdir -p /data /outputs

# ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸
COPY deploy/entrypoint_wld.sh /usr/local/bin/wld
RUN chmod +x /usr/local/bin/wld

# ëŸ°íƒ€ì„ í™˜ê²½
ENV PYTHONUNBUFFERED=1

# ì½”ë“œ ë£¨íŠ¸ë¥¼ ì‘ì—… ë””ë ‰í„°ë¦¬ë¡œ
WORKDIR /workspace/welding_line_detection

# í•„ìš”í•œ ëª¨ë“ˆ ê²½ë¡œë¥¼ 'ì™„ì „íˆ' ì§€ì • (ì´ì „ PYTHONPATHì— ì˜ì¡´ X)
ENV PYTHONPATH=/workspace/welding_line_detection:/workspace/welding_line_detection/script:/workspace/welding_line_detection/FoundationStereo:/workspace/welding_line_detection/Grounded-SAM-2:/workspace/welding_line_detection/Pointcept

# ê¸°ë³¸ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ë¥¼ wldë¡œ (tinië¡œ ì‹ í˜¸ ì²˜ë¦¬)
ENTRYPOINT ["/usr/bin/tini","--","/usr/local/bin/wld"]

# ê¸°ë³¸ ì»¤ë§¨ë“œ (ë„ì›€ë§)
CMD ["help"]

# (ì´ë¯¸ ì„¤ì¹˜í–ˆë‹¤ë©´ ìƒëµ ê°€ëŠ¥) í™•ì¥ ë¹Œë“œìš© íˆ´
RUN apt-get update && apt-get install -y --no-install-recommends \
      build-essential ninja-build && \
    rm -rf /var/lib/apt/lists/*

# GroundingDINO CUDA í™•ì¥ ë¹Œë“œ & ì„¤ì¹˜
WORKDIR /workspace/welding_line_detection/Grounded-SAM-2/grounding_dino
RUN /workspace/isaaclab/_isaac_sim/python.sh -m pip install -v --no-build-isolation .
